<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Chat Room</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #chat-log {
        width: 100%;
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
      }

      .message {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
      }

      .message img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .message .content {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        max-width: 75%;
      }

      .message .sender-name {
        font-weight: bold;
        margin-bottom: 0.3rem;
      }

      .chat-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
      }

      .chat-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 1rem;
      }

      .chat-header h2 {
        margin-bottom: 0;
      }

      .chat-header .receiver-name {
        font-size: 1.2rem;
      }

      .input-group {
        margin-top: 1rem;
      }

      .input-group input {
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
      }

      .input-group button {
        border-radius: 0.25rem;
      }

      .close-button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-left: auto;
        display: block;
      }

      .close-button:hover {
        background-color: #c82333;
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <!-- Chat Header -->
      <div class="chat-header">
        {% if receiver.profile_picture %}
        <img
          src="{{ receiver.profile_picture.url }}"
          alt="Receiver Profile Picture"
        />
        {% else %}
        <img
          src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
          alt="Receiver Profile Picture"
        />
        {% endif %}
        <h2 class="receiver-name">{{ receiver.username }}</h2>
        <!-- Close Button -->
        <button class="close-button" id="close-chat-button">Close Chat</button>
      </div>

      <div id="chat-log">
        {% for message in messages %}
        <div class="message">
          {% if message.sender.profile_picture %}
          <img
            src="{{ message.sender.profile_picture.url }}"
            alt="Sender Profile Picture"
          />
          {% else %}
          <img
            src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
            alt="Sender Profile Picture"
          />
          {% endif %}
          <div class="content">
            <div class="sender-name">{{ message.sender.username }}</div>
            <div>{{ message.message }}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Chat Input -->
      <div class="input-group">
        <input
          id="chat-message-input"
          type="text"
          class="form-control"
          placeholder="Type a message..."
        />
        <div class="input-group-append">
          <button id="chat-message-submit" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>

    <script>
      const senderId = "{{ sender.id }}";
      const receiverId = "{{ receiver.id }}";
      let roomName;

      if (senderId < receiverId) {
        roomName = `${senderId}-${receiverId}`;
      } else {
        roomName = `${receiverId}-${senderId}`;
      }

      const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${roomName}/`
      );

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data); // Parse the message data
        console.log("New message received:", data);

        const chatLog = document.querySelector("#chat-log");

        // Create a new message element to display in the chat
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");

        // Create the profile picture element
        const profilePicture = document.createElement("img");
        profilePicture.src = data.sender_pic; // Use the sender's profile picture or default
        messageElement.appendChild(profilePicture);

        // Create content element
        const contentElement = document.createElement("div");
        contentElement.classList.add("content");

        // Add sender name
        const senderName = document.createElement("div");
        senderName.classList.add("sender-name");
        senderName.textContent = data.sender_name; // Show sender's name
        contentElement.appendChild(senderName);

        // Add the message text
        const messageText = document.createElement("div");
        messageText.textContent = data.message;
        contentElement.appendChild(messageText);

        messageElement.appendChild(contentElement);
        chatLog.appendChild(messageElement);

        // Scroll the chat log to the bottom after adding the new message
        chatLog.scrollTop = chatLog.scrollHeight;
      };

      chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
        // Handle Close Chat button
        document.getElementById("close-chat-button").onclick = function () {
          // Close the WebSocket connection first
          chatSocket.close();

          // Redirect to the dashboard
          window.location.href = "http://localhost:3000/dashboard";
        };
      };

      document.querySelector("#chat-message-input").focus();
      document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.key === "Enter") {
          document.querySelector("#chat-message-submit").click();
        }
      };

      document.querySelector("#chat-message-submit").onclick = function (e) {
        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value;
        if (message) {
          chatSocket.send(
            JSON.stringify({
              message: message,
              sender_id: senderId,
              receiver_id: receiverId,
            })
          );
          messageInputDom.value = "";
        }
      };
    </script>
  </body>
</html>
